name: PR Web Preview (Expo Router -> Pages)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write

concurrency:
  group: pr-web-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Clear existing PR folder on gh-pages
        run: |
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          rm -rf PRs/${{ github.event.pull_request.number }} || true

      - name: Export web (static)
        env:
          # Used by app.config.js to set experiments.baseUrl
          EXPO_PUBLIC_REPO_NAME: ${{ github.event.repository.name }}
          EXPO_PUBLIC_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          npx expo export --platform web --output-dir dist

      - name: Debug dist tree
        run: |
          echo "=== dist root ==="
          ls -la dist
          echo "=== does dist/PRs exist (should not yet) ==="
          ls -la dist/PRs || true
          echo "=== find assets + ionicons ==="
          find dist -maxdepth 4 -type d -name assets -print || true
          find dist -type f \( -name "*Ionicons*.ttf" -o -name "*Ionicons*.woff*" -o -name "*Ionicons*.woff2" \) -print || true

      - name: Deploy PR preview to gh-pages/PRs/<number>
        run: |
          set -e

          PR="PRs/${{ github.event.pull_request.number }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch gh-pages branch
          git fetch origin gh-pages || true

          # Create or checkout gh-pages
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout -B gh-pages origin/gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . || true
          fi

          # Ensure Pages does not run Jekyll (needed for _expo)
          touch .nojekyll

          # Replace just this PR folder
          rm -rf "$PR"
          mkdir -p "$PR"
          cp -R dist/* "$PR/"

          git add -A
          git commit -m "Deploy web preview for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Preview URL
        run: |
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/PRs/${{ github.event.pull_request.number }}/"
