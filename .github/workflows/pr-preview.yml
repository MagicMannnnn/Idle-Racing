name: PR QR (links to PR)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  qr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci --no-audit --prefer-offline

      - name: Install tools
        run: |
          npm install -g qrcode
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Create QR image (opens PR)
        run: |
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
          qrcode "$PR_URL" -o preview-qr.png

      # 1) Create/update the sticky comment (get comment id)
      - name: Upsert sticky comment (placeholder)
        id: sticky
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: '<!-- expo-preview -->'
          edit-mode: replace
          body: |
            <!-- expo-preview -->
            ## ðŸ”— PR Link QR

            ðŸ“± **Scan QR (opens this PR)**  
            (uploading...)

            ---
            Updated automatically on every commit.

      # 2) Upload the image to that comment using GitHub API (this returns a user-images URL)
      - name: Upload image to comment
        id: img
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_ID="${{ steps.sticky.outputs.comment-id }}"

          # GitHubâ€™s comment-attachment upload endpoint
          # We POST the binary, GitHub returns JSON including a hosted URL
          RESP=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${COMMENT_ID}/attachments" \
            -f name="preview-qr.png" \
            -f content_type="image/png" \
            --input preview-qr.png)

          URL=$(echo "$RESP" | jq -r '.browser_download_url // .url // empty')
          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "Attachment upload response:"
            echo "$RESP"
            exit 1
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT

      # 3) Update the sticky comment with the embedded image
      - name: Update sticky comment with embedded QR
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.sticky.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- expo-preview -->
            ## ðŸ”— PR Link QR

            ðŸ”— **PR**
            https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}

            ðŸ“± **Scan QR (opens this PR)**  
            ![](${{ steps.img.outputs.url }})

            ---
            Updated automatically on every commit.
